{
  "hash": "f3adfc03daaf63ca5794defadd4b4fa7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Zonal stats\"\nformat: html\n---\n\n::::::: grid\n::: {.g-col-lg-2 .g-col-md-1 .g-col-sm-0 .g-col-0}\n:::\n\n:::: {.g-col-lg-8 .g-col-md-10 .g-col-sm-12 .g-col-12}\n\n\n**Name:** Zonal stats\n\n**Keywords:** extract, summary stats, spatial aggregation\n\n**Type:** Aggregate\n\n**Description:** Zonal statistics aggregate spatially defined variables over some area. There are  important choices to make when calculating zonal stats. What function should be used to aggregate values across space (mean, median, max, min...)? How should edge cases be treated, where a grid cell is partially covered by the area of interest? Should values first be top or bottom coded to reduce noise, or should they be weighted by another spatial dataset, such as population? The best choice will often depend on your objective and the question being asked. Once these decisions are made, computing zonal stats is straightforward in R using the exactextractr package (or Python or GIS software). The code below demonstrates several different cases and can be modified to suit your requirements.\n\n<small>\n**Usage:** Used in many contexts to calculate summary statistics for a regionâ€¦\n\n**Limitations:** The interpretation of zonal statistics depends on the aggregation method and other choices..\n\n**Examples:** NA\n\n**Input:** Raster from which to extract values and vector. Optional weighting raster.\n\n**Ouput:** Zonal statistics for each area defined by the raster\n\n</small>\n\n**Reproducible code**\n\n::: panel-tabset\n\n## R\n```r\n# Install packages if you haven't already\n# install.packages(\"terra\")\n# install.packages(\"sf\")\n# install.packages(\"exactextractr\")\n# install.packages(\"ggplot2\")\n\n# Load packages\nlibrary(terra)\nlibrary(sf)\nlibrary(exactextractr)\nlibrary(ggplot2)\n\n#------------------------------------------------------------------------------#\n# 1. Calculate zonal statistics (mean of cell values)\n\n# Create a sample raster layer\n# Create a 10x10 raster with values from 1 to 100\nraster_data <- rast(matrix(1:100, nrow = 10, ncol = 10))\n# Set the extent and coordinate reference system (CRS)\next(raster_data) <- c(0, 10, 0, 10)\ncrs(raster_data) <- \"EPSG:4326\"\n\n# Create a sample polygon (sf) object\n# Define two polygons\npoly1 <- st_polygon(list(rbind(c(1, 1), c(4, 1), c(4, 4), c(1, 4), c(1, 1))))\npoly2 <- st_polygon(list(rbind(c(6, 6), c(9, 6), c(9, 9), c(6, 9), c(6, 6))))\n\n# Create an sf object with a data frame\npolygons_sf <- st_as_sf(\n  data.frame(\n    id = c(\"A\", \"B\"),\n    geometry = st_sfc(poly1, poly2, crs = \"EPSG:4326\")\n  )\n)\n\n# Plot the raster and vector data together\nraster_df <- as.data.frame(raster_data, xy = TRUE)\ncolnames(raster_df)[3] <- \"value\"\n\nplot <- ggplot() +\n  geom_raster(data = raster_df, aes(x = x, y = y, fill = value)) +\n  geom_sf(data = polygons_sf, fill = NA, color = \"red\", linewidth = 1) +\n  scale_fill_viridis_c() +\n  coord_sf(crs = \"EPSG:4326\") +\n  labs(\n    title = \"Raster and Vector Data Overlay\",\n    x = \"Longitude\",\n    y = \"Latitude\",\n    fill = \"Value\"\n  ) +\n  theme_minimal()\n\nprint(plot)\n\n# Use exact_extract to find the mean value of the raster within each polygon\nzonal_stats <- exact_extract(raster_data, polygons_sf, \"mean\")\n\n# Combine results and print\n# The result is a vector, which can be added as a new column to the polygon data\npolygons_sf$mean_value <- zonal_stats\nprint(\"Polygons with calculated mean raster value:\")\nprint(polygons_sf)\n\n#------------------------------------------------------------------------------#\n# 2. Calculate multiple statistics at once\nzonal_stats_multiple <- exact_extract(raster_data,\n                                      polygons_sf,\n                                      c(\"min\", \"max\", \"mean\", \"count\"),\n                                      append_cols = \"id\")\nprint(\"Polygons with multiple zonal statistics:\")\nprint(zonal_stats_multiple)\n\n#------------------------------------------------------------------------------#\n# 3. Calculate weighted zonal statistics\n\n# Create a second raster for WEIGHTS\n# Let's create a weight raster where weights increase from bottom-left to top-right\n# This will give more importance to cells with higher values in our value_raster\nweight_matrix <- matrix(1:100, nrow = 10, ncol = 10, byrow = TRUE)\nweight_raster <- rast(weight_matrix)\next(weight_raster) <- c(0, 10, 0, 10)\ncrs(weight_raster) <- \"EPSG:4326\"\n\nvalue_raster <- raster_data # use existing raster for values\n\n# Name the layers in the rasters for clarity in the output\nnames(value_raster) <- \"value\"\nnames(weight_raster) <- \"weight\"\n\n# Calculate Weighted Zonal Statistics\n# To calculate a weighted mean, we provide the weight_raster to the `weights` argument.\n# We also name the summary operation to make the output column clear.\nzonal_stats_weighted <- exact_extract(\n  x = value_raster,\n  y = polygons_sf,\n  fun = c(\"mean\", \"weighted_mean\"), # Calculate both simple and weighted mean\n  weights = weight_raster,\n  append_cols = \"id\"\n)\n\n# Print the results\nprint(\"Comparison of simple mean vs. weighted mean:\")\nprint(zonal_stats_weighted)\n\n#------------------------------------------------------------------------------#\n# 4. Summarize categorical rasters\n\n# Create a sample CATEGORICAL raster for land cover\n# Categories: 1=Water, 2=Forest, 3=Urban\nland_cover_matrix <- matrix(c(\n  1, 1, 2, 2,\n  1, 2, 3, 3,\n  2, 2, 3, 3,\n  2, 3, 3, 3\n), nrow = 4, ncol = 4, byrow = TRUE)\n\nland_cover_raster <- rast(land_cover_matrix)\next(land_cover_raster) <- c(0, 4, 0, 4)\ncrs(land_cover_raster) <- \"EPSG:4326\"\nnames(land_cover_raster) <- \"land_cover\"\n\n# Create a WEIGHT raster (e.g., population density)\n# Let's assume population is highest in the 'Urban' areas (bottom-right)\npopulation_matrix <- matrix(c(\n  5,   5,  10,  20,\n  5,  25, 100, 120,\n  10,  20, 150, 180,\n  10,  50, 200, 250\n), nrow = 4, ncol = 4, byrow = TRUE)\n\npopulation_raster <- rast(population_matrix)\next(population_raster) <- c(0, 4, 0, 4)\ncrs(population_raster) <- \"EPSG:4326\"\nnames(population_raster) <- \"population\"\n\n# Create a sample polygon (sf) object\n# A single polygon covering a mix of land cover types\nanalysis_poly <- st_polygon(list(rbind(c(0.5, 0.5), c(3.5, 0.5), c(3.5, 3.5), c(0.5, 3.5), c(0.5, 0.5))))\n\npolygons_sf <- st_as_sf(\n  data.frame(\n    district_id = \"D1\",\n    geometry = st_sfc(analysis_poly, crs = \"EPSG:4326\")\n  )\n)\n\n# Calculate both unweighted and weighted fractions\n# The function will return a data frame where columns are named `weighted_fraction_<category_value>`\nzonal_fractions <- exact_extract(\n  x = land_cover_raster,\n  y = polygons_sf,\n  fun = c(\"frac\", \"weighted_frac\"), # Calculate both for comparison\n  weights = population_raster,\n  append_cols = \"district_id\"\n)\n\n# Print and interpret the results\nprint(\"Land Cover Raster Categories: 1=Water, 2=Forest, 3=Urban\")\nprint(\"Comparison of unweighted vs. weighted fractions:\")\nprint(zonal_fractions)\n\n# To make the output more readable, let's calculate the total population in the polygon\ntotal_pop <- exact_extract(population_raster, polygons_sf, fun = \"sum\", append_cols = \"district_id\")\nprint(total_pop)\n```\n\n## Output\n\n::: {.cell}\n::: {.cell-output-display}\n![](zonal-stats_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |===================================                                   |  50%\n  |                                                                            \n  |======================================================================| 100%\n[1] \"Polygons with calculated mean raster value:\"\nSimple feature collection with 2 features and 2 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 1 ymin: 1 xmax: 9 ymax: 9\nGeodetic CRS:  WGS 84\n  id                       geometry mean_value\n1  A POLYGON ((1 1, 4 1, 4 4, 1 ...         28\n2  B POLYGON ((6 6, 9 6, 9 9, 6 ...         73\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |===================================                                   |  50%\n  |                                                                            \n  |======================================================================| 100%\n[1] \"Polygons with multiple zonal statistics:\"\n  id min max mean count\n1  A  17  39   28     9\n2  B  62  84   73     9\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |===================================                                   |  50%\n  |                                                                            \n  |======================================================================| 100%\n[1] \"Comparison of simple mean vs. weighted mean:\"\n  id mean weighted_mean\n1  A   28      28.18265\n2  B   73      73.47619\n[1] \"Land Cover Raster Categories: 1=Water, 2=Forest, 3=Urban\"\n[1] \"Comparison of unweighted vs. weighted fractions:\"\n  district_id    frac_1    frac_2    frac_3 weighted_frac_1 weighted_frac_2\n1          D1 0.1388889 0.3888889 0.4722222      0.00952381       0.0952381\n  weighted_frac_3\n1       0.8952381\n  district_id    sum\n1          D1 656.25\n```\n\n\n:::\n:::\n\n\n\n:::\n\n**Last updated:** 10/16/25\n\n::::\n\n::: {.g-col-lg-1 .g-col-md-1 .g-col-sm-0 .g-col-0}\n:::\n:::::::\n\n```{=html}\n<div class=\"secondary-links\">\n  <div class=\"secondary-links-container\">\n      <div class=\"secondary-links-title\">\n      </div>\n      <div class=\"grid\">\n        <div class=\"g-col-lg-4 g-col-md-4 g-col-sm-12\">\n          <ul>\n            <li><a href=\"http://GeoPov/\">Geospatial Poverty Solutions Home</a></li>\n          </ul>\n        </div>\n        <div class=\"g-col-lg-4 g-col-md-4 g-col-sm-12 center-left-border\">\n          <ul>\n            <li><a href=\"https://pipmaps.worldbank.org/\">Geospatial poverty portal</a></li>\n          </ul>\n        </div>\n        <div class=\"g-col-lg-4 g-col-md-4 g-col-sm-12 center-left-border\">\n          <ul>\n            <li><a href=\"mailto:bbrunckhorst@worldbank.org?subject=GeoPov%20data%20and%20methods%20repository\" target=\"_top\">Contact us</a></li>\n          </ul>\n        </div>\n      </div>\n    </div>\n</div>\n```\n\n\n",
    "supporting": [
      "zonal-stats_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}